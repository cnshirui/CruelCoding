<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>残酷刷题群</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
        }
        #loading {
            text-align: center;
            font-size: 1.2em;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        /* Using a clear font for distinguishing l and I */
        .clear-font {
            font-family: "JetBrains Mono", "Cascadia Code", "Source Code Pro", Menlo, Monaco, Consolas, "Courier New", monospace;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }
        th:hover {
            background-color: #ddd;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <h1>残酷刷题群</h1>

    <div id="loading">Loading data...</div>

    <table id="scoreTable" style="display:none;">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Rank</th>
                <th onclick="sortTable(1)">CruelID</th>
                <th onclick="sortTable(2)">CruelDate</th>
                <th onclick="sortTable(3)">Username</th>
                <th onclick="sortTable(4)">Days</th>
                <th onclick="sortTable(5)">Rating</th>
                <th onclick="sortTable(6)">Score</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>

    <script>
        const URLs = {
            excel: 'https://raw.githubusercontent.com/wisdompeak/lc-score-board/refs/heads/gh-pages/generateEXCEL/index.xlsx',
            cruelId: 'https://raw.githubusercontent.com/wisdompeak/lc-score-board/refs/heads/gh-pages/getRank/id.in',
            cruelDate: 'https://raw.githubusercontent.com/wisdompeak/lc-score-board/refs/heads/gh-pages/generateEXCEL/Data/Members/In.txt'
        };

        let tableData = [];

        async function fetchData() {
            try {
                const [excelParams, idParams, dateParams] = await Promise.all([
                    fetch(URLs.excel).then(res => res.arrayBuffer()),
                    fetch(URLs.cruelId).then(res => res.text()),
                    fetch(URLs.cruelDate).then(res => res.text())
                ]);

                const idMap = new Map();
                const idLines = idParams.split('\n');
                idLines.forEach((line, index) => {
                    const name = line.trim();
                    if (name) {
                        idMap.set(name, index + 1);
                    }
                });

                const dateMap = new Map();
                const dateLines = dateParams.split('\n');
                dateLines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length >= 2) {
                        const name = parts[0];
                        const dateStr = parts[1]; // Expected MM/DD/YYYY
                        
                        let formattedDate = dateStr;
                        if (dateStr.includes('/')) {
                            const [m, d, y] = dateStr.split('/');
                            if (m && d && y) {
                                formattedDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                            }
                        }
                        dateMap.set(name, formattedDate);
                    }
                });

                const workbook = XLSX.read(excelParams, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                let dataStartIndex = -1;
                for (let i = 0; i < rawData.length; i++) {
                    if (rawData[i][0] == 1) {
                        dataStartIndex = i;
                        break;
                    }
                }

                if (dataStartIndex === -1) dataStartIndex = 11;

                const processedData = [];
                const footerKeywords = [
                    "-1:", "-2:", "BG Color:", "Full list", "Recommended resources", 
                    "See where we are", "Cruel System Design", "If you are interested", 
                    "Make sure you agree", "[Blacklisted", "Graduated members"
                ];
                
                for (let i = dataStartIndex; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length < 2) continue;

                    const rank = row[0];
                    const username = row[1] ? String(row[1]).trim() : '';
                    
                    if (!username || !rank) continue;

                    if (footerKeywords.some(key => username.includes(key))) {
                        break;
                    }

                    const days = row[2];
                    const rating = row[3];
                    const score = row[4];

                    const cruelId = idMap.get(username) || ''; 
                    const cruelDate = dateMap.get(username) || '';

                    processedData.push({
                        rank: rank,
                        cruelId: cruelId,
                        cruelDate: cruelDate,
                        username: username,
                        days: days,
                        rating: rating,
                        score: score
                    });
                }

                tableData = processedData;
                renderTable(tableData);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('scoreTable').style.display = 'table';

            } catch (error) {
                console.error("Error fetching or processing data:", error);
                document.getElementById('loading').textContent = "Error loading data. Check console for details.";
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.rank || ''}</td>
                    <td class="clear-font">${row.cruelId || ''}</td>
                    <td class="clear-font">${row.cruelDate || ''}</td>
                    <td class="clear-font">${row.username || ''}</td>
                    <td>${row.days || ''}</td>
                    <td>${row.rating || ''}</td>
                    <td>${row.score || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        let sortDirection = {};

        function sortTable(columnIndex) {
            const keys = ['rank', 'cruelId', 'cruelDate', 'username', 'days', 'rating', 'score'];
            const key = keys[columnIndex];
            
            if (!sortDirection[key]) sortDirection[key] = 'asc';
            else sortDirection[key] = sortDirection[key] === 'asc' ? 'desc' : 'asc';

            const dir = sortDirection[key];

            tableData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                
                const isNumeric = !isNaN(numA) && !isNaN(numB) && !['cruelDate', 'username'].includes(key);
                
                if (isNumeric) {
                    valA = numA;
                    valB = numB;
                } else {
                    valA = valA ? String(valA).toLowerCase() : '';
                    valB = valB ? String(valB).toLowerCase() : '';
                }

                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(tableData);
        }

        fetchData();
    </script>
</body>
</html>
